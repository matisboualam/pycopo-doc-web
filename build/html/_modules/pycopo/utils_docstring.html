

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pycopo.utils_docstring &#8212; pycopo 0.0.1 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/pycopo/utils_docstring';</script>
    <link rel="shortcut icon" href="https://gitlab.com/uploads/-/system/project/avatar/15363012/6x6_1000-12.jpeg?width=64"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
    
    
      
    
    
    <img src="https://gitlab.com/uploads/-/system/project/avatar/15363012/6x6_1000-12.jpeg?width=64" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="https://gitlab.com/uploads/-/system/project/avatar/15363012/6x6_1000-12.jpeg?width=64" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../Installation.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../pycopo_theory.html">
                        The theory behind Pycopo
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../modules.html">
                        Pycopo module dictionnary
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../tutorial.html">
                        Jupyter Notebook tutorial
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://www.univ-smb.fr/symme/">
                    SYMME
                  </a>
                </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://gitlab.com/symmehub/pycopo" title="GitLab" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-gitlab"></i></span>
            <label class="sr-only">GitLab</label></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../Installation.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../pycopo_theory.html">
                        The theory behind Pycopo
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../modules.html">
                        Pycopo module dictionnary
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../tutorial.html">
                        Jupyter Notebook tutorial
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://www.univ-smb.fr/symme/">
                    SYMME
                  </a>
                </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://gitlab.com/symmehub/pycopo" title="GitLab" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-gitlab"></i></span>
            <label class="sr-only">GitLab</label></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<h3><a href="../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../pycopo_theory.html">The theory behind Pycopo</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Pycopo module dictionnary</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Jupyter Notebook tutorial</a></li>
</ul>
</div>
        <div class="sidebar-primary-item">
<div id="searchbox"></div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">pycopo.utils_docstring</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for pycopo.utils_docstring</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">more_itertools</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">cv2</span> <span class="kn">import</span> <span class="n">aruco</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">io</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">pycopo</span> <span class="k">as</span> <span class="nn">pcp</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pdb</span> <span class="kn">import</span> <span class="n">set_trace</span>

    <span class="n">set_trace</span><span class="p">()</span>


<div class="viewcode-block" id="read_camera_calibration"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.read_camera_calibration">[docs]</a><span class="k">def</span> <span class="nf">read_camera_calibration</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function loads a json file and returns the camera matrix and distortion coefficients.</span>

<span class="sd">    :param path: The path to the json file.</span>
<span class="sd">    :type path: str</span>
<span class="sd">    :return: The camera matrix and distortion coefficients.</span>
<span class="sd">    :rtype: tuple&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;camera_matrix&quot;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;distortion_coefficients&quot;</span><span class="p">]))</span></div>


<div class="viewcode-block" id="save_camera_calibration"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.save_camera_calibration">[docs]</a><span class="k">def</span> <span class="nf">save_camera_calibration</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">camera_matrix</span><span class="p">,</span> <span class="n">distortion_coefficients</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function converts a camera matrix and distortion coefficients from numpy arrays to lists.</span>

<span class="sd">    :param camera_matrix: The camera matrix to convert.</span>
<span class="sd">    :type camera_matrix: numpy.array</span>
<span class="sd">    :param distortion_coefficients: The distortion coefficients to convert.</span>
<span class="sd">    :type distortion_coefficients: numpy.array</span>
<span class="sd">    :return: The camera matrix and distortion coefficients as lists.</span>
<span class="sd">    :rtype: dict&quot;&quot;&quot;</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">camera_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">distortion_coefficients</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;camera_matrix&quot;</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span> <span class="s2">&quot;distortion_coefficients&quot;</span><span class="p">:</span> <span class="n">D</span><span class="p">}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="save_marker_calibration"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.save_marker_calibration">[docs]</a><span class="k">def</span> <span class="nf">save_marker_calibration</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ids3D</span><span class="p">,</span> <span class="n">points3D</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function renames the keys of a dictionary according to a list of new keys.</span>

<span class="sd">    :param dict_: The dictionary to rename the keys of.</span>
<span class="sd">    :type dict_: dict</span>
<span class="sd">    :param new_keys: The new keys to use.</span>
<span class="sd">    :type new_keys: list</span>
<span class="sd">    :return: The dictionary with the new keys.</span>
<span class="sd">    :rtype: dict&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">rename_keys</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">new_keys</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function takes a dictionary and returns a new dictionary with the keys swapped.</span>

<span class="sd">        :param dict_: The dictionary to be swapped.</span>
<span class="sd">        :type dict_: dict</span>
<span class="sd">        :return: The dictionary with the keys swapped.</span>
<span class="sd">        :rtype: dict&quot;&quot;&quot;</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dict_</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">new_keys</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">d1</span><span class="p">[</span><span class="n">oldK</span><span class="p">]:</span> <span class="n">value</span> <span class="k">for</span> <span class="p">(</span><span class="n">oldK</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dict_</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ids3D</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">ids3D</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">ids3D</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out</span><span class="p">[</span><span class="n">ids3D</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">points3D</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">tab_str_ids3D</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ids3D</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids3D</span><span class="p">)])):</span>
        <span class="n">tab_str_ids3D</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ids3D</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids3D</span><span class="p">)][</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">new_out</span> <span class="o">=</span> <span class="n">rename_keys</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">tab_str_ids3D</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">new_out</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_marker_calibration"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.read_marker_calibration">[docs]</a><span class="k">def</span> <span class="nf">read_marker_calibration</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function loads data from a json file.</span>

<span class="sd">    :param path: The path to the json file.</span>
<span class="sd">    :type path: str</span>
<span class="sd">    :return: A tuple containing an array of ids and an array of points.</span>
<span class="sd">    :rtype: tuple&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="n">ids3D</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">points3D</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ids3D</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
        <span class="n">points3D</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ids3D</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points3D</span><span class="p">))</span></div>


<div class="viewcode-block" id="invert_RT"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.invert_RT">[docs]</a><span class="k">def</span> <span class="nf">invert_RT</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function calculates the inverse of a given rotation and translation.</span>

<span class="sd">    :param R: The rotation to invert.</span>
<span class="sd">    :type R: numpy.array</span>
<span class="sd">    :param T: The translation to invert.</span>
<span class="sd">    :type T: numpy.array</span>
<span class="sd">    :return: The inverse of the given rotation and translation.</span>
<span class="sd">    :rtype: tuple&quot;&quot;&quot;</span>
    <span class="n">Ti</span> <span class="o">=</span> <span class="o">-</span><span class="n">cv2</span><span class="o">.</span><span class="n">Rodrigues</span><span class="p">(</span><span class="o">-</span><span class="n">R</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">R</span><span class="p">,</span> <span class="n">Ti</span><span class="p">)</span></div>


<div class="viewcode-block" id="compose_RT"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.compose_RT">[docs]</a><span class="k">def</span> <span class="nf">compose_RT</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">R2</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function composes two rotation-and-shift transformations, returning the combined rotation and shift.</span>

<span class="sd">    :param R1: The first rotation matrix.</span>
<span class="sd">    :type R1: numpy array</span>
<span class="sd">    :param T1: The first translation vector.</span>
<span class="sd">    :type T1: numpy array</span>
<span class="sd">    :param R2: The second rotation matrix.</span>
<span class="sd">    :type R2: numpy array</span>
<span class="sd">    :param T2: The second translation vector.</span>
<span class="sd">    :type T2: numpy array</span>
<span class="sd">    :return: The combined rotation and shift.</span>
<span class="sd">    :rtype: tuple&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">composeRT</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">R2</span><span class="p">,</span> <span class="n">T2</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span></div>


<div class="viewcode-block" id="change_reference"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.change_reference">[docs]</a><span class="k">def</span> <span class="nf">change_reference</span><span class="p">(</span><span class="n">R10</span><span class="p">,</span> <span class="n">T10</span><span class="p">,</span> <span class="n">R20</span><span class="p">,</span> <span class="n">T20</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function inverts the given RT composition.</span>

<span class="sd">    :param R10: The first rotation matrix of the composition.</span>
<span class="sd">    :type R10: numpy.array</span>
<span class="sd">    :param T10: The first translation vector of the composition.</span>
<span class="sd">    :type T10: numpy.array</span>
<span class="sd">    :param R20: The second rotation matrix of the composition.</span>
<span class="sd">    :type R20: numpy.array</span>
<span class="sd">    :param T20: The second translation vector of the composition.</span>
<span class="sd">    :type T20: numpy.array</span>
<span class="sd">    :return: The inverse of the given RT composition.</span>
<span class="sd">    :rtype: tuple&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">R01</span><span class="p">,</span> <span class="n">T01</span><span class="p">)</span> <span class="o">=</span> <span class="n">invert_RT</span><span class="p">(</span><span class="n">R10</span><span class="p">,</span> <span class="n">T10</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">compose_RT</span><span class="p">(</span><span class="n">R20</span><span class="p">,</span> <span class="n">T20</span><span class="p">,</span> <span class="n">R01</span><span class="p">,</span> <span class="n">T01</span><span class="p">)</span></div>


<div class="viewcode-block" id="apply_RT"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.apply_RT">[docs]</a><span class="k">def</span> <span class="nf">apply_RT</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function converts a rotation matrix to a 3x1 vector.</span>

<span class="sd">    :param R: The rotation matrix to convert.</span>
<span class="sd">    :type R: numpy.array</span>
<span class="sd">    :return: The 3x1 vector representation of the rotation matrix.</span>
<span class="sd">    :rtype: numpy.array&quot;&quot;&quot;</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Rodrigues</span><span class="p">(</span><span class="n">R</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">P</span> <span class="o">+=</span> <span class="n">T</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">P</span></div>


<span class="n">_XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]],</span>
        <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]],</span>
        <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]],</span>
    <span class="p">],</span>
    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">_RGB</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">]]</span>
<span class="n">_VERTS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">]</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">_draw_axis</span><span class="p">(</span>
    <span class="n">im</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">,</span>
    <span class="n">rvec</span><span class="p">,</span>
    <span class="n">tvec</span><span class="p">,</span>
    <span class="n">camera_matrix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">distortion_coefficients</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
    <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">thickness</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function projects 3D points to an image plane.</span>

<span class="sd">    :param axis: The 3D points to project.</span>
<span class="sd">    :type axis: numpy array of shape (3,N)</span>
<span class="sd">    :param rvec: The rotation vector of the object.</span>
<span class="sd">    :type rvec: numpy array of shape (3,)</span>
<span class="sd">    :param tvec: The translation vector of the object.</span>
<span class="sd">    :type tvec: numpy array of shape (3,)</span>
<span class="sd">    :param camera_matrix: The camera matrix.</span>
<span class="sd">    :type camera_matrix: numpy array of shape (3,3)</span>
<span class="sd">    :param distortion_coefficients: The distortion coefficients of the camera.</span>
<span class="sd">    :type distortion_coefficients: numpy array of shape (5,)</span>
<span class="sd">    :return: The projected points and the jacobian.</span>
<span class="sd">    :rtype: tuple of two numpy arrays&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">axproj</span><span class="p">,</span> <span class="n">jac</span><span class="p">)</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">projectPoints</span><span class="p">(</span>
        <span class="n">axis</span><span class="p">,</span> <span class="n">rvec</span><span class="p">,</span> <span class="n">tvec</span><span class="p">,</span> <span class="n">camera_matrix</span><span class="p">,</span> <span class="n">distortion_coefficients</span>
    <span class="p">)</span>
    <span class="n">axproj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">axproj</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">arrowedLine</span><span class="p">(</span>
        <span class="n">im</span><span class="p">,</span>
        <span class="n">pt1</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">axproj</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">pt2</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">axproj</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
        <span class="n">thickness</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">thickness</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">im</span>


<div class="viewcode-block" id="draw_markers"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.draw_markers">[docs]</a><span class="k">def</span> <span class="nf">draw_markers</span><span class="p">(</span><span class="n">ids2D</span><span class="p">,</span> <span class="n">corners2D</span><span class="p">,</span> <span class="n">imout</span><span class="p">,</span> <span class="n">rejected</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function draws detected markers on an image.</span>

<span class="sd">    :param imout: The image to draw on.</span>
<span class="sd">    :type imout: numpy.array</span>
<span class="sd">    :param c2D: The corners of the detected markers.</span>
<span class="sd">    :type c2D: numpy.array</span>
<span class="sd">    :param i2D: The ids of the detected markers.</span>
<span class="sd">    :type i2D: numpy.array</span>
<span class="sd">    :param rejected: The corners of the rejected markers.</span>
<span class="sd">    :type rejected: numpy.array</span>
<span class="sd">    :return: The image with the drawn markers.</span>
<span class="sd">    :rtype: numpy.array&quot;&quot;&quot;</span>
    <span class="n">Nm</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids2D</span><span class="p">)</span>
    <span class="n">i2D</span> <span class="o">=</span> <span class="n">ids2D</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Nm</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">c2D</span> <span class="o">=</span> <span class="n">corners2D</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Nm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">aruco</span><span class="o">.</span><span class="n">drawDetectedMarkers</span><span class="p">(</span><span class="n">imout</span><span class="p">,</span> <span class="n">c2D</span><span class="p">,</span> <span class="n">i2D</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rejected</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cross</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">corners2D</span><span class="p">[</span><span class="n">rejected</span><span class="p">][:,</span> <span class="n">cross</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">pts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">imout</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">polylines</span><span class="p">(</span><span class="n">imout</span><span class="p">,</span> <span class="n">pts</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">thickness</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">imout</span></div>


<div class="viewcode-block" id="draw_xyz"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.draw_xyz">[docs]</a><span class="k">def</span> <span class="nf">draw_xyz</span><span class="p">(</span>
    <span class="n">im</span><span class="p">,</span>
    <span class="n">rvec</span><span class="p">,</span>
    <span class="n">tvec</span><span class="p">,</span>
    <span class="n">dimension</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">camera_matrix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">distortion_coefficients</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
    <span class="n">thickness</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function draws an axis on an image.</span>

<span class="sd">    :param im: The image to draw the axis on.</span>
<span class="sd">    :type im: numpy.array</span>
<span class="sd">    :param axis: The axis to draw.</span>
<span class="sd">    :type axis: numpy.array</span>
<span class="sd">    :param rvec: The rotation vector of the camera.</span>
<span class="sd">    :type rvec: numpy.array</span>
<span class="sd">    :param tvec: The translation vector of the camera.</span>
<span class="sd">    :type tvec: numpy.array</span>
<span class="sd">    :param camera_matrix: The camera matrix of the camera.</span>
<span class="sd">    :type camera_matrix: numpy.array</span>
<span class="sd">    :param distortion_coefficients: The distortion coefficients of the camera.</span>
<span class="sd">    :type distortion_coefficients: numpy.array</span>
<span class="sd">    :param color: The color of the axis.</span>
<span class="sd">    :type color: numpy.array</span>
<span class="sd">    :param thickness: The thickness of the axis.</span>
<span class="sd">    :type thickness: int</span>
<span class="sd">    :return: The image with the axis drawn on it.</span>
<span class="sd">    :rtype: numpy.array&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">_draw_axis</span><span class="p">(</span>
            <span class="n">im</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="n">_XYZ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">dimension</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="n">rvec</span><span class="o">=</span><span class="n">rvec</span><span class="p">,</span>
            <span class="n">tvec</span><span class="o">=</span><span class="n">tvec</span><span class="p">,</span>
            <span class="n">camera_matrix</span><span class="o">=</span><span class="n">camera_matrix</span><span class="p">,</span>
            <span class="n">distortion_coefficients</span><span class="o">=</span><span class="n">distortion_coefficients</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">_RGB</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">thickness</span><span class="o">=</span><span class="n">thickness</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">im</span></div>


<div class="viewcode-block" id="checkdir"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.checkdir">[docs]</a><span class="k">def</span> <span class="nf">checkdir</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s2">&quot;./outputs/&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function creates a directory if it does not exist.</span>

<span class="sd">    :param directory: The directory to create.</span>
<span class="sd">    :type directory: str</span>
<span class="sd">    :return: The directory created.</span>
<span class="sd">    :rtype: str&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">directory</span></div>


<div class="viewcode-block" id="Markers"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.Markers">[docs]</a><span class="k">class</span> <span class="nc">Markers</span><span class="p">:</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="create_image_dataFrame"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.create_image_dataFrame">[docs]</a><span class="k">def</span> <span class="nf">create_image_dataFrame</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;This function generates a pandas DataFrame with MultiIndex columns from a list of tuples.</span>

<span class="sd">    :param cols: The list of tuples to use as columns.</span>
<span class="sd">    :type cols: list</span>
<span class="sd">    :return: The generated DataFrame.</span>
<span class="sd">    :rtype: pandas.DataFrame&quot;&quot;&quot;</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">([(</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;fname&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)])</span>
    <span class="n">data_img</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">data_img</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;images&quot;</span>
    <span class="k">return</span> <span class="n">data_img</span></div>


<div class="viewcode-block" id="create_detect_dataFrame"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.create_detect_dataFrame">[docs]</a><span class="k">def</span> <span class="nf">create_detect_dataFrame</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;This function returns a DataFrame with columns as MultiIndex.</span>

<span class="sd">    :param cols: The columns of the DataFrame.</span>
<span class="sd">    :type cols: pd.MultiIndex</span>
<span class="sd">    :return: The DataFrame with specified columns.</span>
<span class="sd">    :rtype: pd.DataFrame&quot;&quot;&quot;</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;images&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span> <span class="s2">&quot;dimension&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span> <span class="s2">&quot;area&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;p2d&quot;</span><span class="p">,</span> <span class="s2">&quot;c0&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;p2d&quot;</span><span class="p">,</span> <span class="s2">&quot;c0&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;p2d&quot;</span><span class="p">,</span> <span class="s2">&quot;c1&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;p2d&quot;</span><span class="p">,</span> <span class="s2">&quot;c1&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;p2d&quot;</span><span class="p">,</span> <span class="s2">&quot;c2&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;p2d&quot;</span><span class="p">,</span> <span class="s2">&quot;c2&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;p2d&quot;</span><span class="p">,</span> <span class="s2">&quot;c3&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;p2d&quot;</span><span class="p">,</span> <span class="s2">&quot;c3&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">data_detect</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">data_detect</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;detects&quot;</span>
    <span class="k">return</span> <span class="n">data_detect</span></div>


<div class="viewcode-block" id="create_pose_dataFrame"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.create_pose_dataFrame">[docs]</a><span class="k">def</span> <span class="nf">create_pose_dataFrame</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;This function generates a pandas DataFrame with MultiIndex columns.</span>

<span class="sd">    :param cols: A list of tuples specifying the column names.</span>
<span class="sd">    :type cols: list</span>
<span class="sd">    :return: A pandas DataFrame with MultiIndex columns.</span>
<span class="sd">    :rtype: pandas.DataFrame&quot;&quot;&quot;</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;detects&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;rvec&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;rvec&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;rvec&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tvec&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tvec&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tvec&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="s2">&quot;validated&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="s2">&quot;rejected&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="s2">&quot;pose&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;occurency&quot;</span><span class="p">,</span> <span class="s2">&quot;good&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;occurency&quot;</span><span class="p">,</span> <span class="s2">&quot;bad&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">data_pose</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">data_pose</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;poses&quot;</span>
    <span class="k">return</span> <span class="n">data_pose</span></div>


<div class="viewcode-block" id="dump_dataframe_HDF"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.dump_dataframe_HDF">[docs]</a><span class="k">def</span> <span class="nf">dump_dataframe_HDF</span><span class="p">(</span>
    <span class="n">img_dir</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">,</span> <span class="n">meta_filename</span><span class="o">=</span><span class="s2">&quot;metadata.h5&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataframe</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function writes a pandas DataFrame to an HDF5 file.</span>

<span class="sd">    :param img_dir: The directory to write the file to.</span>
<span class="sd">    :type img_dir: str</span>
<span class="sd">    :param meta_filename: The name of the file to write.</span>
<span class="sd">    :type meta_filename: str</span>
<span class="sd">    :param key: The key to use for the DataFrame in the file.</span>
<span class="sd">    :type key: str</span>
<span class="sd">    :param mode: The mode to open the file in.</span>
<span class="sd">    :type mode: str&quot;&quot;&quot;</span>
    <span class="n">dataframe</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">img_dir</span> <span class="o">+</span> <span class="n">meta_filename</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="cherry_dataframe_HDF"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.cherry_dataframe_HDF">[docs]</a><span class="k">def</span> <span class="nf">cherry_dataframe_HDF</span><span class="p">(</span><span class="n">img_dir</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">,</span> <span class="n">meta_filename</span><span class="o">=</span><span class="s2">&quot;metadata.h5&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function reads an HDF5 file into a pandas DataFrame.</span>

<span class="sd">    :param img_dir: The directory containing the HDF5 file.</span>
<span class="sd">    :type img_dir: str</span>
<span class="sd">    :param meta_filename: The name of the HDF5 file.</span>
<span class="sd">    :type meta_filename: str</span>
<span class="sd">    :return: A pandas DataFrame containing the data from the HDF5 file.</span>
<span class="sd">    :rtype: pandas.DataFrame&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">img_dir</span> <span class="o">+</span> <span class="n">meta_filename</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_batch"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.load_batch">[docs]</a><span class="k">def</span> <span class="nf">load_batch</span><span class="p">(</span><span class="n">batch_instance</span><span class="p">,</span> <span class="n">lpath</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s2">&quot;batch.p&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function loads a pickled batch file and returns a Batch instance.</span>

<span class="sd">    :param lpath: The path to the pickled batch file.</span>
<span class="sd">    :type lpath: str</span>
<span class="sd">    :param fname: The name of the pickled batch file.</span>
<span class="sd">    :type fname: str</span>
<span class="sd">    :return: The Batch instance.</span>
<span class="sd">    :rtype: Batch&quot;&quot;&quot;</span>
    <span class="n">data_batch</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">lpath</span> <span class="o">+</span> <span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
    <span class="n">batch_instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data_batch</span><span class="p">[</span><span class="s2">&quot;batch&quot;</span><span class="p">])</span>
    <span class="n">batch_instance</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">aruco</span><span class="o">.</span><span class="n">DetectorParameters_create</span><span class="p">()</span>
    <span class="n">batch_instance</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">cornerRefinementWinSize</span> <span class="o">=</span> <span class="n">data_batch</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span>
        <span class="s2">&quot;cornerRefinementWinSize&quot;</span>
    <span class="p">]</span>
    <span class="n">batch_instance</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">cornerRefinementMaxIterations</span> <span class="o">=</span> <span class="n">data_batch</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span>
        <span class="s2">&quot;cornerRefinementMaxIterations&quot;</span>
    <span class="p">]</span>
    <span class="n">batch_instance</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">cornerRefinementMethod</span> <span class="o">=</span> <span class="n">data_batch</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span>
        <span class="s2">&quot;cornerRefinementMethod&quot;</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">batch_instance</span></div>


<div class="viewcode-block" id="load_image_batch"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.load_image_batch">[docs]</a><span class="k">def</span> <span class="nf">load_image_batch</span><span class="p">(</span><span class="n">data_img</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function creates a dataframe of image filenames.</span>

<span class="sd">    :param directory: The directory to search for images.</span>
<span class="sd">    :type directory: str</span>
<span class="sd">    :param format: The image file format to search for.</span>
<span class="sd">    :type format: str</span>
<span class="sd">    :param slice: The number of images to return.</span>
<span class="sd">    :type slice: int</span>
<span class="sd">    :return: A dataframe of image filenames.</span>
<span class="sd">    :rtype: pandas.DataFrame&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data_img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_img</span> <span class="o">=</span> <span class="n">create_image_dataFrame</span><span class="p">()</span>
    <span class="n">data_img_temp</span> <span class="o">=</span> <span class="n">create_image_dataFrame</span><span class="p">()</span>
    <span class="n">im_fnames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="nb">format</span><span class="p">)])</span>
    <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">im_fnames</span> <span class="o">=</span> <span class="n">im_fnames</span><span class="p">[::</span><span class="nb">slice</span><span class="p">]</span>
    <span class="n">Ni</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">im_fnames</span><span class="p">)</span>
    <span class="n">data_img_temp</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span><span class="si">}</span><span class="s2">/&quot;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ni</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">data_img_temp</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;fname&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_fnames</span>
    <span class="n">data_img</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_img</span><span class="p">,</span> <span class="n">data_img_temp</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">data_img</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;images&quot;</span>
    <span class="k">return</span> <span class="n">data_img</span></div>


<div class="viewcode-block" id="detect_markers"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.detect_markers">[docs]</a><span class="k">def</span> <span class="nf">detect_markers</span><span class="p">(</span>
    <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">marker_dimension</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">aruco_dict</span><span class="o">=</span><span class="n">aruco</span><span class="o">.</span><span class="n">DICT_6X6_250</span><span class="p">,</span>
    <span class="n">output_directory</span><span class="o">=</span><span class="s2">&quot;/_outputs/&quot;</span><span class="p">,</span>
    <span class="n">data_img</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">data_detect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_markers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_image_type</span><span class="o">=</span><span class="s2">&quot;jpg&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function detects markers in images and returns the dataframe.</span>

<span class="sd">    :param data_img: The dataframe containing the images.</span>
<span class="sd">    :type data_img: pandas dataframe</span>
<span class="sd">    :param aruco_dict: The aruco dictionary to use for marker detection.</span>
<span class="sd">    :type aruco_dict: aruco dictionary</span>
<span class="sd">    :param parameters: The parameters to use for marker detection.</span>
<span class="sd">    :type parameters: aruco parameters</span>
<span class="sd">    :param marker_dimension: The dimensions of the markers to use for marker detection.</span>
<span class="sd">    :type marker_dimension: dict</span>
<span class="sd">    :param plot_markers: Whether to plot the markers.</span>
<span class="sd">    :type plot_markers: bool</span>
<span class="sd">    :param output_directory: The directory to output the plot to.</span>
<span class="sd">    :type output_directory: str</span>
<span class="sd">    :param plot_image_type: The type of image to output the plot as.</span>
<span class="sd">    :type plot_image_type: str</span>
<span class="sd">    :return: The dataframe containing the marker detections.</span>
<span class="sd">    :rtype: pandas dataframe&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data_detect</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_detect</span> <span class="o">=</span> <span class="n">create_detect_dataFrame</span><span class="p">()</span>
    <span class="n">data_detect_temp</span> <span class="o">=</span> <span class="n">create_detect_dataFrame</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">aruco</span><span class="o">.</span><span class="n">DetectorParameters_create</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">marker_dimension</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">marker_dimension</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)}</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_img</span><span class="p">)))</span>
    <span class="n">cpt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">data_img</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">data_img</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">fname</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;Detecting markers on: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">rgb</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rgb</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2GRAY</span><span class="p">)</span>
        <span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="n">ids2D</span><span class="p">,</span> <span class="n">points2D</span><span class="p">)</span> <span class="o">=</span> <span class="n">pcp</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">detect_markers</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="n">dictionary</span><span class="o">=</span><span class="n">aruco_dict</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span> <span class="n">drop_duplicates</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">Nm</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids2D</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plot_markers</span><span class="p">:</span>
                <span class="n">imout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">frame</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">frame</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">draw_markers</span><span class="p">(</span><span class="n">ids2D</span><span class="p">,</span> <span class="n">points2D</span><span class="p">,</span> <span class="n">imout</span><span class="p">,</span> <span class="n">rejected</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">output_directory</span> <span class="o">=</span> <span class="n">checkdir</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">output_directory</span><span class="p">)</span>
                <span class="n">io</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span>
                    <span class="n">output_directory</span>
                    <span class="o">+</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span> <span class="s2">&quot;_markers.&quot;</span>
                    <span class="o">+</span> <span class="n">plot_image_type</span><span class="p">,</span>
                    <span class="n">imout</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nm</span><span class="p">):</span>
                <span class="n">marker_id</span> <span class="o">=</span> <span class="n">ids2D</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">marker_id</span> <span class="ow">in</span> <span class="n">marker_dimension</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">data_detect_temp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">ii</span> <span class="o">+</span> <span class="n">cpt</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;images&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data_img</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
                        <span class="n">ii</span>
                    <span class="p">]</span>
                    <span class="n">data_detect_temp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                        <span class="n">ii</span> <span class="o">+</span> <span class="n">cpt</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">cornerRefinementMethod</span>
                    <span class="n">data_detect_temp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">ii</span> <span class="o">+</span> <span class="n">cpt</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">marker_id</span>
                    <span class="n">data_detect_temp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                        <span class="n">ii</span> <span class="o">+</span> <span class="n">cpt</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span> <span class="s2">&quot;dimension&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">marker_dimension</span><span class="p">[</span><span class="n">marker_id</span><span class="p">]</span>
                    <span class="n">data_detect_temp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                        <span class="n">ii</span> <span class="o">+</span> <span class="n">cpt</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span> <span class="s2">&quot;area&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">pcp</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">marker_area</span><span class="p">(</span><span class="n">points2D</span><span class="p">)[</span><span class="n">m</span><span class="p">]</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)):</span>
                        <span class="n">data_detect_temp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                            <span class="n">ii</span> <span class="o">+</span> <span class="n">cpt</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;p2d&quot;</span><span class="p">,</span> <span class="s2">&quot;c</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s2">&quot;xy&quot;</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">points2D</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                    <span class="n">cpt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No markers found on </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
    <span class="n">data_detect</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_detect</span><span class="p">,</span> <span class="n">data_detect_temp</span><span class="p">])</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">data_detect</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data_detect</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;detects&quot;</span>
    <span class="k">return</span> <span class="n">data_detect</span></div>


<div class="viewcode-block" id="estimate_pose"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.estimate_pose">[docs]</a><span class="k">def</span> <span class="nf">estimate_pose</span><span class="p">(</span>
    <span class="n">data_detect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">data_pose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">camera_matrix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
    <span class="n">distortion_coefficients</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">]),</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function calculates the pose of a marker using a known camera matrix and distortion coefficients.</span>

<span class="sd">    :param points2D: The 2D points of the marker.</span>
<span class="sd">    :type points2D: numpy.array</span>
<span class="sd">    :param points3D: The 3D points of the marker.</span>
<span class="sd">    :type points3D: numpy.array</span>
<span class="sd">    :param camera_matrix: The camera matrix.</span>
<span class="sd">    :type camera_matrix: numpy.array</span>
<span class="sd">    :param distortion_coefficients: The distortion coefficients.</span>
<span class="sd">    :type distortion_coefficients: numpy.array</span>
<span class="sd">    :return: The status, rvec0, tvec0, rvec1, tvec1, sol0, and sol1 of the marker.</span>
<span class="sd">    :rtype: tuple&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_status</span><span class="p">(</span><span class="n">pose</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function returns True if status is 0, False if status is 2, and pose is 0 if status is 1.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pose</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">data_pose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_pose</span> <span class="o">=</span> <span class="n">create_pose_dataFrame</span><span class="p">()</span>
    <span class="n">data_pose_temp</span> <span class="o">=</span> <span class="n">create_pose_dataFrame</span><span class="p">()</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_detect</span><span class="p">)))</span>
    <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span>
            <span class="s2">&quot;Estimating pose on detect id_detect: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_detect</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">points3D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">pcp</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">get_corners</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="n">data_detect</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">dimension</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">points2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_detect</span><span class="o">.</span><span class="n">p2d</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">pcp</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">estimate_pose_planar</span><span class="p">(</span>
            <span class="n">points2D</span><span class="o">=</span><span class="n">points2D</span><span class="p">,</span>
            <span class="n">points3D</span><span class="o">=</span><span class="n">points3D</span><span class="p">,</span>
            <span class="n">camera_matrix</span><span class="o">=</span><span class="n">camera_matrix</span><span class="p">,</span>
            <span class="n">distortion_coefficients</span><span class="o">=</span><span class="n">distortion_coefficients</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">rvec0</span><span class="p">,</span> <span class="n">tvec0</span><span class="p">,</span> <span class="n">rvec1</span><span class="p">,</span> <span class="n">tvec1</span><span class="p">,</span> <span class="n">sol0</span><span class="p">,</span> <span class="n">sol1</span><span class="p">)</span> <span class="o">=</span> <span class="n">out</span>
        <span class="n">rvecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">rvec0</span><span class="p">,</span> <span class="n">rvec1</span><span class="p">]</span>
        <span class="n">tvecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">tvec0</span><span class="p">,</span> <span class="n">tvec1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">data_pose_temp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;rvec&quot;</span><span class="p">,</span> <span class="s2">&quot;xyz&quot;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">rvecs</span><span class="p">[</span><span class="n">pose</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">data_pose_temp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;tvec&quot;</span><span class="p">,</span> <span class="s2">&quot;xyz&quot;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tvecs</span><span class="p">[</span><span class="n">pose</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">data_pose_temp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;detects&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data_detect</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">data_pose_temp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="s2">&quot;pose&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_get_status</span><span class="p">(</span><span class="n">pose</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pose</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">data_pose_temp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;pose&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;regular&quot;</span>
                    <span class="k">if</span> <span class="n">sol0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">data_pose_temp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sol0</span><span class="o">.</span><span class="n">fun</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data_pose_temp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data_pose_temp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;pose&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;planar&quot;</span>
                    <span class="k">if</span> <span class="n">sol1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">data_pose_temp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sol1</span><span class="o">.</span><span class="n">fun</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data_pose_temp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">data_pose_temp</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">data_pose_temp</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="s2">&quot;validated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">data_pose_temp</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="s2">&quot;rejected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">data_pose_temp</span><span class="p">[</span><span class="s2">&quot;occurency&quot;</span><span class="p">,</span> <span class="s2">&quot;bad&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">data_pose_temp</span><span class="p">[</span><span class="s2">&quot;occurency&quot;</span><span class="p">,</span> <span class="s2">&quot;good&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">data_pose</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_pose</span><span class="p">,</span> <span class="n">data_pose_temp</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">data_pose</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data_pose</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;poses&quot;</span>
    <span class="k">return</span> <span class="n">data_pose</span></div>


<div class="viewcode-block" id="calculate_inner_angles"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.calculate_inner_angles">[docs]</a><span class="k">def</span> <span class="nf">calculate_inner_angles</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function calculates the angles between the vertices of a cube and the 45 degree lines.</span>

<span class="sd">    :param p2d: The 2D coordinates of the cube vertices.</span>
<span class="sd">    :type p2d: pandas.DataFrame</span>
<span class="sd">    :return: The angles between the vertices of the cube and the 45 degree lines.</span>
<span class="sd">    :rtype: pandas.DataFrame&quot;&quot;&quot;</span>
    <span class="n">p2d</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">p2d</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">p2d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.0</span>
    <span class="n">angles</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
        <span class="p">[[</span><span class="s2">&quot;angles&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;c0&quot;</span><span class="p">,</span> <span class="s2">&quot;c1&quot;</span><span class="p">,</span> <span class="s2">&quot;c2&quot;</span><span class="p">,</span> <span class="s2">&quot;c3&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;a0&quot;</span><span class="p">,</span> <span class="s2">&quot;a1&quot;</span><span class="p">]]</span>
    <span class="p">)</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vertices</span><span class="p">)):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">p2d</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">p2d</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">p2d</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">AB</span> <span class="o">=</span> <span class="n">B</span> <span class="o">-</span> <span class="n">A</span>
        <span class="n">AC</span> <span class="o">=</span> <span class="n">C</span> <span class="o">-</span> <span class="n">A</span>
        <span class="n">AB</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">AB</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">AC</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">AC</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">AB</span><span class="p">,</span> <span class="n">AC</span><span class="p">))</span>
        <span class="n">angles</span><span class="p">[</span><span class="s2">&quot;angles&quot;</span><span class="p">,</span> <span class="s2">&quot;c</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;a</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span>
            <span class="n">angle</span>
        <span class="p">)</span>
    <span class="n">deviation</span> <span class="o">=</span> <span class="n">angles</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">-</span> <span class="mf">45.0</span>
    <span class="n">deviation</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
        <span class="p">[[</span><span class="s2">&quot;angular_deviation&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;c0&quot;</span><span class="p">,</span> <span class="s2">&quot;c1&quot;</span><span class="p">,</span> <span class="s2">&quot;c2&quot;</span><span class="p">,</span> <span class="s2">&quot;c3&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;a0&quot;</span><span class="p">,</span> <span class="s2">&quot;a1&quot;</span><span class="p">]]</span>
    <span class="p">)</span>
    <span class="n">abs_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">deviation</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">deviation</span><span class="p">[</span><span class="s2">&quot;angular_deviation&quot;</span><span class="p">,</span> <span class="s2">&quot;abs_max&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">abs_max</span>
    <span class="n">data_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">angles</span><span class="p">,</span> <span class="n">deviation</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data_out</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span>
    <span class="k">return</span> <span class="n">data_out</span></div>


<div class="viewcode-block" id="filter_mk_by_img"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.filter_mk_by_img">[docs]</a><span class="k">def</span> <span class="nf">filter_mk_by_img</span><span class="p">(</span><span class="n">data_detect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_mk</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function merges two dataframes together and returns the result.</span>

<span class="sd">    :param data_detect: The first dataframe to merge.</span>
<span class="sd">    :type data_detect: pandas dataframe</span>
<span class="sd">    :param pcp.utils.calculate_inner_angles(data_detect): The second dataframe to merge.</span>
<span class="sd">    :type pcp.utils.calculate_inner_angles(data_detect): pandas dataframe</span>
<span class="sd">    :return: The merged dataframe.</span>
<span class="sd">    :rtype: pandas dataframe&quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pcp</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">merge_dataFrames</span><span class="p">(</span>
        <span class="n">data_detect</span><span class="p">,</span>
        <span class="n">pcp</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">calculate_inner_angles</span><span class="p">(</span><span class="n">data_detect</span><span class="p">)[</span>
            <span class="s2">&quot;angular_deviation&quot;</span><span class="p">,</span> <span class="s2">&quot;abs_max&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">new_data_detect</span> <span class="o">=</span> <span class="n">pcp</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">create_detect_dataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">sub_df</span><span class="p">)</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;images&quot;</span><span class="p">):</span>
        <span class="n">sub_df_sorted</span> <span class="o">=</span> <span class="n">sub_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">((</span><span class="s2">&quot;angular_deviation&quot;</span><span class="p">,</span> <span class="s2">&quot;abs_max&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">sub_df_sorted</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_mk</span><span class="p">:</span>
            <span class="n">sub_df_new</span> <span class="o">=</span> <span class="n">sub_df_sorted</span>
            <span class="n">sub_df_new</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;angular_deviation&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">new_data_detect</span> <span class="o">=</span> <span class="n">new_data_detect</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_df_new</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">new_data_detect</span><span class="p">[</span><span class="s2">&quot;detects&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_data_detect</span><span class="p">[</span><span class="s2">&quot;detects&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">int64</span>
    <span class="p">)</span>
    <span class="n">new_data_detect</span><span class="o">.</span><span class="n">set_index</span><span class="p">([(</span><span class="s2">&quot;detects&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)],</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">new_data_detect</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">new_data_detect</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">new_data_detect</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">data_detect</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span>
    <span class="k">return</span> <span class="n">new_data_detect</span></div>


<div class="viewcode-block" id="filter_angles"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.filter_angles">[docs]</a><span class="k">def</span> <span class="nf">filter_angles</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">criterion_angular</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function calculates the inner angles of a dataframe and returns the result.</span>

<span class="sd">    :param data: The dataframe to calculate the inner angles.</span>
<span class="sd">    :type data: pandas.DataFrame</span>
<span class="sd">    :return: The inner angles of the dataframe.</span>
<span class="sd">    :rtype: pandas.DataFrame&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;p2d&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;No &#39;pd2&#39; attribute found in input dataframe</span><span class="se">\r</span><span class="s2"> Please try with compatible dataframe&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_angle</span> <span class="o">=</span> <span class="n">calculate_inner_angles</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">criterion_angular</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_angle</span><span class="p">)</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">data_angle</span><span class="o">.</span><span class="n">angular_deviation</span><span class="o">.</span><span class="n">abs_max</span><span class="o">.</span><span class="n">values</span> <span class="o">&lt;=</span> <span class="n">criterion_angular</span>
        <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">data_angle</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">locs</span><span class="p">])</span></div>


<div class="viewcode-block" id="filter_areas"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.filter_areas">[docs]</a><span class="k">def</span> <span class="nf">filter_areas</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">criterion_area</span><span class="o">=</span><span class="mf">0.65</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function returns the indices of dataframe rows where the value of the &#39;markers.area&#39; column is greater than a certain criterion.</span>

<span class="sd">    :param data: The dataframe to be searched.</span>
<span class="sd">    :type data: pandas.DataFrame</span>
<span class="sd">    :param criterion_area: The criterion to be used for searching.</span>
<span class="sd">    :type criterion_area: float</span>
<span class="sd">    :return: The indices of rows in the dataframe where the value of the &#39;markers.area&#39; column is greater than the criterion.</span>
<span class="sd">    :rtype: list&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">markers</span><span class="p">,</span> <span class="s2">&quot;area&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;No &#39;markers.area&#39; attribute found in input dataframe</span><span class="se">\r</span><span class="s2"> Please try with compatible dataframe&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;images&quot;</span><span class="p">)</span>
        <span class="n">img_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">img_ids</span><span class="p">:</span>
            <span class="n">idata</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            <span class="n">area_max</span> <span class="o">=</span> <span class="n">idata</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">area</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="n">criterion_area</span>
            <span class="p">[</span>
                <span class="n">locs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">idata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idata</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;=</span> <span class="n">area_max</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="n">locs</span></div>


<div class="viewcode-block" id="merge_dataFrames"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.merge_dataFrames">[docs]</a><span class="k">def</span> <span class="nf">merge_dataFrames</span><span class="p">(</span><span class="n">dataFrame1</span><span class="p">,</span> <span class="n">dataFrame2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function resets the index of two dataframes and returns the difference of the columns.</span>

<span class="sd">    :param dataFrame1: The first dataframe to reset the index of.</span>
<span class="sd">    :type dataFrame1: pandas dataframe</span>
<span class="sd">    :param dataFrame2: The second dataframe to reset the index of.</span>
<span class="sd">    :type dataFrame2: pandas dataframe</span>
<span class="sd">    :return: The difference of the columns of dataFrame1 and dataFrame2.</span>
<span class="sd">    :rtype: pandas dataframe&quot;&quot;&quot;</span>
    <span class="n">dataFrame1</span> <span class="o">=</span> <span class="n">dataFrame1</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">dataFrame2</span> <span class="o">=</span> <span class="n">dataFrame2</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">diff_cols</span> <span class="o">=</span> <span class="n">dataFrame2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">dataFrame1</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">inter_cols</span> <span class="o">=</span> <span class="n">dataFrame2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">dataFrame1</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inter_cols</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">key_col</span> <span class="o">=</span> <span class="n">inter_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">dataFrame1</span><span class="p">,</span> <span class="n">dataFrame2</span><span class="p">[</span><span class="n">diff_cols</span><span class="p">],</span> <span class="n">left_on</span><span class="o">=</span><span class="n">key_col</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No corespondance key column was found !&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="get_multigraph"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.get_multigraph">[docs]</a><span class="k">def</span> <span class="nf">get_multigraph</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function maps strings to integers and returns the result.</span>

<span class="sd">    :param data: The data to map.</span>
<span class="sd">    :type data: dict</span>
<span class="sd">    :param prefix: The prefix to use for the mapped strings.</span>
<span class="sd">    :type prefix: str</span>
<span class="sd">    :return: The mapped data.</span>
<span class="sd">    :rtype: dict&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">im_dicin</span><span class="p">,</span> <span class="n">im_dicout</span><span class="p">)</span> <span class="o">=</span> <span class="n">string_map</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">marker_dicin</span><span class="p">,</span> <span class="n">marker_dicout</span><span class="p">)</span> <span class="o">=</span> <span class="n">string_map</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
    <span class="n">MG</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiGraph</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">imlabel</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;images&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">n0</span> <span class="o">=</span> <span class="n">combination</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="n">combination</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">MG</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">n0</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">im_dicin</span><span class="p">[</span><span class="n">imlabel</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">MG</span></div>


<div class="viewcode-block" id="get_central_marker"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.get_central_marker">[docs]</a><span class="k">def</span> <span class="nf">get_central_marker</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function returns the center of a multigraph.</span>

<span class="sd">    :param data: The data to get the multigraph from.</span>
<span class="sd">    :type data: dict</span>
<span class="sd">    :return: The center of the multigraph.</span>
<span class="sd">    :rtype: int&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">get_multigraph</span><span class="p">(</span><span class="n">data</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_graph"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.get_graph">[docs]</a><span class="k">def</span> <span class="nf">get_graph</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function generates a graph from data.</span>

<span class="sd">    :param data: The data to generate the graph from.</span>
<span class="sd">    :type data: pandas dataframe</span>
<span class="sd">    :return: The generated graph.</span>
<span class="sd">    :rtype: networkx graph&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">im_dicin</span><span class="p">,</span> <span class="n">im_dicout</span><span class="p">)</span> <span class="o">=</span> <span class="n">string_map</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">marker_dicin</span><span class="p">,</span> <span class="n">marker_dicout</span><span class="p">)</span> <span class="o">=</span> <span class="n">string_map</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="n">dp</span> <span class="o">=</span> <span class="n">data</span>
    <span class="n">successful_detects</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">pose</span><span class="p">]</span><span class="o">.</span><span class="n">detects</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;detects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">successful_detects</span><span class="p">)]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im_dicin</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="n">marker_dicin</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ma</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">G</span></div>


<div class="viewcode-block" id="string_map"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.string_map">[docs]</a><span class="k">def</span> <span class="nf">string_map</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">zfill</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function creates a dictionary with keys being the integers from 0 to the length of the input list and values being the input list with a prefix added to each string.</span>

<span class="sd">    :param ids: The list of strings to add the prefix to.</span>
<span class="sd">    :type ids: list</span>
<span class="sd">    :param prefix: The prefix to add to each string in the list.</span>
<span class="sd">    :type prefix: str</span>
<span class="sd">    :return: A tuple containing the dictionary with the integer keys and the input list with the prefix added to each string.</span>
<span class="sd">    :rtype: tuple&quot;&quot;&quot;</span>
    <span class="n">lel</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">zfill</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">lel</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lel</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
    <span class="n">dic_in</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">lel</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">}</span>
    <span class="n">dic_out</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dic_in</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">dic_in</span><span class="p">,</span> <span class="n">dic_out</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_graph"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.plot_graph">[docs]</a><span class="k">def</span> <span class="nf">plot_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">MG</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function draws a graph using the spring layout.</span>

<span class="sd">    :param G: The graph to be drawn.</span>
<span class="sd">    :type G: networkx.Graph</span>
<span class="sd">    :param path: The path to save the figure. If None, the figure will be shown instead.</span>
<span class="sd">    :type path: str or None</span>
<span class="sd">    :return: None</span>
<span class="sd">    :rtype: None&quot;&quot;&quot;</span>
    <span class="n">markers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">MG</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
    <span class="n">centralMarkers</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">MG</span><span class="p">)</span>
    <span class="n">nonCentralMarkers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">markers</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">MG</span><span class="p">))</span>
    <span class="n">images</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">markers</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">spring_layout</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
    <span class="n">posMG</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">spring_layout</span><span class="p">(</span><span class="n">MG</span><span class="p">)</span>
    <span class="n">nsize</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span>
        <span class="n">MG</span><span class="p">,</span>
        <span class="n">posMG</span><span class="p">,</span>
        <span class="n">nodelist</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">centralMarkers</span><span class="p">),</span>
        <span class="n">node_color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span>
        <span class="n">node_size</span><span class="o">=</span><span class="n">nsize</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span>
        <span class="n">MG</span><span class="p">,</span>
        <span class="n">posMG</span><span class="p">,</span>
        <span class="n">nodelist</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">nonCentralMarkers</span><span class="p">),</span>
        <span class="n">node_color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span>
        <span class="n">node_size</span><span class="o">=</span><span class="n">nsize</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span>
        <span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="n">images</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="n">nsize</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span>
    <span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">MG</span><span class="p">,</span> <span class="n">posMG</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_labels</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="graph_path_RTs"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.graph_path_RTs">[docs]</a><span class="k">def</span> <span class="nf">graph_path_RTs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function maps strings to integers and returns the result.</span>

<span class="sd">    :param prefix: The prefix to use.</span>
<span class="sd">    :type prefix: str</span>
<span class="sd">    :return: The mapped strings.</span>
<span class="sd">    :rtype: int&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">marker_dicin</span><span class="p">,</span> <span class="n">marker_dicout</span><span class="p">)</span> <span class="o">=</span> <span class="n">string_map</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">im_dicin</span><span class="p">,</span> <span class="n">im_dicout</span><span class="p">)</span> <span class="o">=</span> <span class="n">string_map</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">)</span>
    <span class="n">cycle</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
    <span class="n">cycle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cycle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">Ne</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">poses</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">edges_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ne</span><span class="p">):</span>
        <span class="n">edges_ids</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">no</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">cycle</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">cycle</span><span class="p">[</span><span class="n">e</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">inverted</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">imageLabel</span><span class="p">,</span> <span class="n">marker</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">no</span><span class="p">)</span> <span class="k">if</span> <span class="n">inverted</span> <span class="k">else</span> <span class="p">(</span><span class="n">no</span><span class="p">,</span> <span class="n">ni</span><span class="p">)</span>
        <span class="n">edge_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span>
            <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">images</span> <span class="o">==</span> <span class="n">im_dicout</span><span class="p">[</span><span class="n">imageLabel</span><span class="p">])</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">marker_dicout</span><span class="p">[</span><span class="n">marker</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="ow">in</span> <span class="n">edge_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">Re</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">rvec</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">Te</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">tvec</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inverted</span><span class="p">:</span>
                <span class="p">(</span><span class="n">Re</span><span class="p">,</span> <span class="n">Te</span><span class="p">)</span> <span class="o">=</span> <span class="n">invert_RT</span><span class="p">(</span><span class="n">Re</span><span class="p">,</span> <span class="n">Te</span><span class="p">)</span>
            <span class="n">poses</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">poses</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Re</span><span class="p">,</span> <span class="n">Te</span><span class="p">)</span>
            <span class="n">edges_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">poses</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">poses</span><span class="p">,</span> <span class="n">edges_ids</span><span class="p">)</span></div>


<div class="viewcode-block" id="graph_path_RT"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.graph_path_RT">[docs]</a><span class="k">def</span> <span class="nf">graph_path_RT</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nodeIn</span><span class="p">,</span> <span class="n">nodeOut</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;dist&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function calculates the relative orientation and position of two cameras given a set of corresponding points.</span>

<span class="sd">    :param data: A dataframe containing the image name, marker name, rvec, and tvec for each corresponding point.</span>
<span class="sd">    :type data: pandas.DataFrame</span>
<span class="sd">    :param nodeIn: The starting node for the path.</span>
<span class="sd">    :type nodeIn: str</span>
<span class="sd">    :param nodeOut: The ending node for the path.</span>
<span class="sd">    :type nodeOut: str</span>
<span class="sd">    :return: The relative orientation and position of the two cameras.</span>
<span class="sd">    :rtype: tuple(numpy.array, numpy.array)&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">marker_dicin</span><span class="p">,</span> <span class="n">marker_dicout</span><span class="p">)</span> <span class="o">=</span> <span class="n">string_map</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">im_dicin</span><span class="p">,</span> <span class="n">im_dicout</span><span class="p">)</span> <span class="o">=</span> <span class="n">string_map</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">nodeIn</span><span class="p">,</span> <span class="n">nodeOut</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;dist&quot;</span><span class="p">)</span>
    <span class="n">Ne</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ne</span><span class="p">):</span>
        <span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">no</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="n">e</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">inverted</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">imageLabel</span><span class="p">,</span> <span class="n">marker</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">no</span><span class="p">)</span> <span class="k">if</span> <span class="n">inverted</span> <span class="k">else</span> <span class="p">(</span><span class="n">no</span><span class="p">,</span> <span class="n">ni</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span>
            <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">images</span> <span class="o">==</span> <span class="n">im_dicout</span><span class="p">[</span><span class="n">imageLabel</span><span class="p">])</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">marker_dicout</span><span class="p">[</span><span class="n">marker</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="n">Re</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">rvec</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">Te</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">tvec</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">inverted</span><span class="p">:</span>
            <span class="p">(</span><span class="n">Re</span><span class="p">,</span> <span class="n">Te</span><span class="p">)</span> <span class="o">=</span> <span class="n">invert_RT</span><span class="p">(</span><span class="n">Re</span><span class="p">,</span> <span class="n">Te</span><span class="p">)</span>
        <span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span> <span class="o">=</span> <span class="n">compose_RT</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">Te</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_residual_RT"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.get_residual_RT">[docs]</a><span class="k">def</span> <span class="nf">get_residual_RT</span><span class="p">(</span><span class="n">permutations_poses</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function calculates the residuals for a given set of permutations and poses.</span>

<span class="sd">    :param permutations_poses: The permutations and poses to calculate the residuals for.</span>
<span class="sd">    :type permutations_poses: numpy array</span>
<span class="sd">    :return: The residuals for the given permutations and poses.</span>
<span class="sd">    :rtype: numpy array&quot;&quot;&quot;</span>
    <span class="n">Np</span> <span class="o">=</span> <span class="n">permutations_poses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Nl</span> <span class="o">=</span> <span class="n">permutations_poses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Np</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Np</span><span class="p">):</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nl</span><span class="p">):</span>
            <span class="p">(</span><span class="n">Re</span><span class="p">,</span> <span class="n">Te</span><span class="p">)</span> <span class="o">=</span> <span class="n">permutations_poses</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>
            <span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span> <span class="o">=</span> <span class="n">compose_RT</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">Te</span><span class="p">)</span>
        <span class="n">residuals</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">R</span>
        <span class="n">residuals</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span>
    <span class="k">return</span> <span class="n">residuals</span></div>


<div class="viewcode-block" id="cycle_permutation_residuals"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.cycle_permutation_residuals">[docs]</a><span class="k">def</span> <span class="nf">cycle_permutation_residuals</span><span class="p">(</span><span class="n">edges_ids</span><span class="p">,</span> <span class="n">poses</span><span class="p">,</span> <span class="n">size_of_cycle</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function calculates the permutations, rotational residuals, and translational residuals of a given set of edges_ids.</span>

<span class="sd">    :param edges_ids: The list of edge_ids to calculate the permutations, rotational residuals, and translational residuals for.</span>
<span class="sd">    :type edges_ids: list</span>
<span class="sd">    :return: The permutations, rotational residuals, and translational residuals of the given edges_ids.</span>
<span class="sd">    :rtype: tuple&quot;&quot;&quot;</span>
    <span class="n">permutations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">edges_ids</span><span class="p">))</span>
    <span class="n">permutations_poses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">poses</span><span class="p">[</span><span class="n">rt</span><span class="p">]</span> <span class="k">for</span> <span class="n">per</span> <span class="ow">in</span> <span class="n">permutations</span> <span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="n">per</span><span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges_ids</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">residual_RT</span> <span class="o">=</span> <span class="n">get_residual_RT</span><span class="p">(</span><span class="n">permutations_poses</span><span class="p">)</span>
    <span class="n">T_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">residual_RT</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">size_of_cycle</span>
    <span class="n">R_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">residual_RT</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">size_of_cycle</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">permutations</span><span class="p">,</span> <span class="n">R_residuals</span><span class="p">,</span> <span class="n">T_residuals</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_cycles"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.get_cycles">[docs]</a><span class="k">def</span> <span class="nf">get_cycles</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atomic_cycle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;basis&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function generates a list of strings that represent the cycles in a graph.</span>

<span class="sd">    :param graph: The graph to find the cycles in.</span>
<span class="sd">    :type graph: networkx.Graph</span>
<span class="sd">    :param root: The root node to start the search from. If None, a random node will be chosen.</span>
<span class="sd">    :type root: str</span>
<span class="sd">    :param kind: The type of cycles to find. Can be &#39;basis&#39; or &#39;all&#39;.</span>
<span class="sd">    :type kind: str</span>
<span class="sd">    :param atomic_cycle: Whether to return only cycles of length 4.</span>
<span class="sd">    :type atomic_cycle: bool</span>
<span class="sd">    :return: The list of cycles in the graph.</span>
<span class="sd">    :rtype: list&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">marker_dicin</span><span class="p">,</span> <span class="n">marker_dicout</span><span class="p">)</span> <span class="o">=</span> <span class="n">string_map</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">im_dicin</span><span class="p">,</span> <span class="n">im_dicout</span><span class="p">)</span> <span class="o">=</span> <span class="n">string_map</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">marker_dicin</span><span class="p">[</span><span class="n">root</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;basis&quot;</span><span class="p">:</span>
        <span class="n">raw_cycles</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">cycle_basis</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">root</span><span class="p">)</span>
    <span class="n">cycles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rc</span> <span class="ow">in</span> <span class="n">raw_cycles</span><span class="p">:</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="n">more_itertools</span><span class="o">.</span><span class="n">circular_shifts</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">perms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">perm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="n">cycles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">atomic_cycle</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">cycle</span> <span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">cycles</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cycles</span></div>


<div class="viewcode-block" id="get_occurencies"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.get_occurencies">[docs]</a><span class="k">def</span> <span class="nf">get_occurencies</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cycles</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function calculates the number of times each pose is &#39;bad&#39; or &#39;good&#39; in the graph path of each cycle, and also flags each pose as &#39;processed&#39;.</span>

<span class="sd">    :param data: The dataframe containing the RTs of each edge in each cycle.</span>
<span class="sd">    :type data: pandas.DataFrame</span>
<span class="sd">    :param cycles: The list of cycles.</span>
<span class="sd">    :type cycles: list</span>
<span class="sd">    :param criterion: The criterion for deciding whether a pose is &#39;bad&#39; or &#39;good&#39;.</span>
<span class="sd">    :type criterion: float</span>
<span class="sd">    :return: The dataframe with the updated &#39;occurency&#39; and &#39;flag&#39; columns.</span>
<span class="sd">    :rtype: pandas.DataFrame&quot;&quot;&quot;</span>
    <span class="n">occurrency</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">pose</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bad&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;good&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span> <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="p">}</span>
    <span class="n">data_out</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data_out</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s2">&quot;occurency&quot;</span><span class="p">,</span> <span class="s2">&quot;bad&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">data_out</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s2">&quot;occurency&quot;</span><span class="p">,</span> <span class="s2">&quot;good&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;Working on cycle: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cycles</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
        <span class="p">(</span><span class="n">poses</span><span class="p">,</span> <span class="n">edges_ids</span><span class="p">)</span> <span class="o">=</span> <span class="n">graph_path_RTs</span><span class="p">(</span><span class="n">data_out</span><span class="p">,</span> <span class="n">cycles</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="p">(</span><span class="n">permutations</span><span class="p">,</span> <span class="n">R_residuals</span><span class="p">,</span> <span class="n">T_residuals</span><span class="p">)</span> <span class="o">=</span> <span class="n">cycle_permutation_residuals</span><span class="p">(</span>
            <span class="n">edges_ids</span><span class="o">=</span><span class="n">edges_ids</span><span class="p">,</span> <span class="n">poses</span><span class="o">=</span><span class="n">poses</span><span class="p">,</span> <span class="n">size_of_cycle</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">best_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">R_residuals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">criterion</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_locs</span><span class="p">):</span>
            <span class="n">best_poses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">permutations</span><span class="p">)[</span><span class="n">best_locs</span><span class="p">]</span>
            <span class="n">bad_poses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">permutations</span><span class="p">),</span> <span class="n">best_locs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">bad</span> <span class="ow">in</span> <span class="n">bad_poses</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
                <span class="n">occurrency</span><span class="p">[</span><span class="n">bad</span><span class="p">][</span><span class="s2">&quot;bad&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">best</span> <span class="ow">in</span> <span class="n">best_poses</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
                <span class="n">occurrency</span><span class="p">[</span><span class="n">best</span><span class="p">][</span><span class="s2">&quot;good&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">permutations</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
                <span class="n">occurrency</span><span class="p">[</span><span class="n">perm</span><span class="p">][</span><span class="s2">&quot;bad&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">permutations</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
            <span class="n">occurrency</span><span class="p">[</span><span class="n">perm</span><span class="p">][</span><span class="s2">&quot;processed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="n">occurrency</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">data_out</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;occurency&quot;</span><span class="p">,</span> <span class="s2">&quot;bad&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;bad&quot;</span><span class="p">]</span>
        <span class="n">data_out</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;occurency&quot;</span><span class="p">,</span> <span class="s2">&quot;good&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;good&quot;</span><span class="p">]</span>
        <span class="n">data_out</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;processed&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data_out</span></div>


<div class="viewcode-block" id="get_occurencies2"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.get_occurencies2">[docs]</a><span class="k">def</span> <span class="nf">get_occurencies2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cycles</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function removes nan values from an array and returns the reshaped array.</span>

<span class="sd">    :param X: The array from which to remove nan values.</span>
<span class="sd">    :type X: numpy array</span>
<span class="sd">    :param shape: The desired shape of the output array.</span>
<span class="sd">    :type shape: tuple</span>
<span class="sd">    :return: The array with nan values removed, reshaped to the desired shape.</span>
<span class="sd">    :rtype: numpy array&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">remove_nan</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function returns an array with the same shape as the input array, X, with all nan values removed.</span>

<span class="sd">        :param X: The input array.</span>
<span class="sd">        :type X: numpy array</span>
<span class="sd">        :return: The array with all nan values removed.</span>
<span class="sd">        :rtype: numpy array&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">X</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">occurrency</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">pose</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bad&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;good&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span> <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="p">}</span>
    <span class="n">data_out</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data_out</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s2">&quot;occurency&quot;</span><span class="p">,</span> <span class="s2">&quot;bad&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">data_out</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s2">&quot;occurency&quot;</span><span class="p">,</span> <span class="s2">&quot;good&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Nc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span>
    <span class="n">Ne</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cycles</span><span class="p">])</span>
    <span class="n">Np</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">Ne</span>
    <span class="n">fpermutations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Nc</span> <span class="o">*</span> <span class="n">Np</span><span class="p">,</span> <span class="n">Ne</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">fpermutations_poses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Nc</span> <span class="o">*</span> <span class="n">Np</span><span class="p">,</span> <span class="n">Ne</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">fresidual_RT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Nc</span> <span class="o">*</span> <span class="n">Np</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">fR_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">Nc</span> <span class="o">*</span> <span class="n">Np</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;Working on cycle: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cycles</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
        <span class="p">(</span><span class="n">poses</span><span class="p">,</span> <span class="n">edges_ids</span><span class="p">)</span> <span class="o">=</span> <span class="n">pcp</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">graph_path_RTs</span><span class="p">(</span><span class="n">data_out</span><span class="p">,</span> <span class="n">cycles</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="n">Nec</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges_ids</span><span class="p">)</span>
        <span class="n">permutations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">edges_ids</span><span class="p">))</span>
        <span class="n">permutations_poses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">poses</span><span class="p">[</span><span class="n">rt</span><span class="p">]</span> <span class="k">for</span> <span class="n">per</span> <span class="ow">in</span> <span class="n">permutations</span> <span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="n">per</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges_ids</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">residual_RT</span> <span class="o">=</span> <span class="n">pcp</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_residual_RT</span><span class="p">(</span><span class="n">permutations_poses</span><span class="p">)</span>
        <span class="n">R_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">residual_RT</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">Nec</span>
        <span class="n">Ncp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">permutations</span><span class="p">)</span>
        <span class="n">Ned</span> <span class="o">=</span> <span class="n">Ne</span> <span class="o">-</span> <span class="n">Nec</span>
        <span class="k">if</span> <span class="n">Ned</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">add_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Ncp</span><span class="p">,</span> <span class="n">Ned</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1000000.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">permutations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">permutations</span><span class="p">),</span> <span class="n">add_p</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">add_pp</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">Ncp</span><span class="p">,</span> <span class="n">Ned</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1000000.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">permutations_poses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">permutations_poses</span><span class="p">,</span> <span class="n">add_pp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ncp</span><span class="p">):</span>
            <span class="n">fpermutations</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">permutations</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">fpermutations_poses</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">permutations_poses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">fresidual_RT</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">residual_RT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">fR_residuals</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">R_residuals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">fpermutations</span> <span class="o">=</span> <span class="n">remove_nan</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">fpermutations</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Ne</span><span class="p">))</span>
    <span class="n">fpermutations_poses</span> <span class="o">=</span> <span class="n">remove_nan</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">fpermutations_poses</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Ne</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">fresidual_RT</span> <span class="o">=</span> <span class="n">remove_nan</span><span class="p">(</span><span class="n">fresidual_RT</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">fR_residuals</span> <span class="o">=</span> <span class="n">remove_nan</span><span class="p">(</span><span class="n">fR_residuals</span><span class="p">,</span> <span class="n">shape</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">best_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">fR_residuals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">criterion</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">bad_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">fR_residuals</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">criterion</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">best_poses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">best_locs</span><span class="p">:</span>
        <span class="p">[</span><span class="n">best_poses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pose</span><span class="p">))</span> <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="n">fpermutations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">pose</span> <span class="o">!=</span> <span class="mf">1000000.0</span><span class="p">]</span>
    <span class="n">bad_poses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bad_locs</span><span class="p">:</span>
        <span class="p">[</span><span class="n">bad_poses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pose</span><span class="p">))</span> <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="n">fpermutations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">pose</span> <span class="o">!=</span> <span class="mf">1000000.0</span><span class="p">]</span>
    <span class="p">(</span><span class="n">best_values</span><span class="p">,</span> <span class="n">best_counts</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">best_poses</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="p">(</span><span class="n">bad_values</span><span class="p">,</span> <span class="n">bad_counts</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bad_poses</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="p">(</span><span class="n">proc_values</span><span class="p">,</span> <span class="n">proc_counts</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">fpermutations</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">occurrency</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">pose</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bad&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;good&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span> <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">ps</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">best_values</span><span class="p">):</span>
        <span class="n">occurrency</span><span class="p">[</span><span class="n">ps</span><span class="p">][</span><span class="s2">&quot;good&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_counts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">ps</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bad_values</span><span class="p">):</span>
        <span class="n">occurrency</span><span class="p">[</span><span class="n">ps</span><span class="p">][</span><span class="s2">&quot;bad&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bad_counts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">ps</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">proc_values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ps</span> <span class="o">!=</span> <span class="mf">1000000.0</span><span class="p">:</span>
            <span class="n">occurrency</span><span class="p">[</span><span class="n">ps</span><span class="p">][</span><span class="s2">&quot;processed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="n">occurrency</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">data_out</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;occurency&quot;</span><span class="p">,</span> <span class="s2">&quot;bad&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;bad&quot;</span><span class="p">]</span>
        <span class="n">data_out</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;occurency&quot;</span><span class="p">,</span> <span class="s2">&quot;good&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;good&quot;</span><span class="p">]</span>
        <span class="n">data_out</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;processed&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data_out</span></div>


<div class="viewcode-block" id="occurency_analysis"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.occurency_analysis">[docs]</a><span class="k">def</span> <span class="nf">occurency_analysis</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">alpha_criterion</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is used to filter out the data.</span>

<span class="sd">    :param data: The data to be filtered.</span>
<span class="sd">    :type data: pandas DataFrame</span>
<span class="sd">    :return: The filtered data.</span>
<span class="sd">    :rtype: pandas DataFrame&quot;&quot;&quot;</span>
    <span class="n">no_pose_core</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">pose</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
    <span class="n">out_of_cycle_core</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">pose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">processed</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">list_of_interest</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;detects&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;occurency&quot;</span><span class="p">,</span> <span class="s2">&quot;good&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;occurency&quot;</span><span class="p">,</span> <span class="s2">&quot;bad&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;fname&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">full_core</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">pose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">processed</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
    <span class="p">][</span><span class="n">list_of_interest</span><span class="p">]</span>
    <span class="n">ind_bad</span> <span class="o">=</span> <span class="n">full_core</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">full_core</span><span class="o">.</span><span class="n">occurency</span><span class="o">.</span><span class="n">good</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
    <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">ind_bad</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="s2">&quot;rejected&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">bad_core</span> <span class="o">=</span> <span class="n">full_core</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">full_core</span><span class="o">.</span><span class="n">occurency</span><span class="o">.</span><span class="n">good</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">not_bad_core</span> <span class="o">=</span> <span class="n">full_core</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">full_core</span><span class="o">.</span><span class="n">occurency</span><span class="o">.</span><span class="n">good</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">detects_unknow</span> <span class="o">=</span> <span class="n">not_bad_core</span><span class="p">[</span><span class="n">not_bad_core</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">][</span><span class="s2">&quot;detects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">known_core</span> <span class="o">=</span> <span class="n">not_bad_core</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">not_bad_core</span><span class="p">[</span><span class="s2">&quot;detects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">detects_unknow</span><span class="p">)]</span>
    <span class="n">detects_toChoose</span> <span class="o">=</span> <span class="n">known_core</span><span class="p">[</span><span class="n">known_core</span><span class="p">[</span><span class="s2">&quot;detects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">][</span><span class="s2">&quot;detects&quot;</span><span class="p">]</span>
    <span class="n">prim_valid_poses</span> <span class="o">=</span> <span class="n">known_core</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="o">~</span><span class="n">known_core</span><span class="p">[</span><span class="s2">&quot;detects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">detects_toChoose</span><span class="p">)</span>
    <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prim_valid_poses</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="s2">&quot;validated&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">toChoose_core</span> <span class="o">=</span> <span class="n">known_core</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">known_core</span><span class="p">[</span><span class="s2">&quot;detects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">detects_toChoose</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">detect</span> <span class="ow">in</span> <span class="n">detects_toChoose</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
        <span class="n">sub_df</span> <span class="o">=</span> <span class="n">toChoose_core</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">toChoose_core</span><span class="p">[</span><span class="s2">&quot;detects&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">detect</span><span class="p">]</span>
        <span class="n">loc_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">sub_df</span><span class="o">.</span><span class="n">occurency</span><span class="o">.</span><span class="n">good</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">loc_reject</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">sub_df</span><span class="o">.</span><span class="n">occurency</span><span class="o">.</span><span class="n">good</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">good_pose</span> <span class="o">=</span> <span class="n">sub_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">loc_valid</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="n">bad_pose</span> <span class="o">=</span> <span class="n">sub_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">loc_reject</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="n">count_max</span> <span class="o">=</span> <span class="n">sub_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">loc_valid</span><span class="p">]</span><span class="o">.</span><span class="n">occurency</span><span class="o">.</span><span class="n">good</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">count_min</span> <span class="o">=</span> <span class="n">sub_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">loc_reject</span><span class="p">]</span><span class="o">.</span><span class="n">occurency</span><span class="o">.</span><span class="n">good</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">count_max</span> <span class="o">/</span> <span class="n">count_min</span>
        <span class="k">if</span> <span class="n">alpha</span> <span class="o">&gt;=</span> <span class="n">alpha_criterion</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">good_pose</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="s2">&quot;validated&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bad_pose</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="s2">&quot;rejected&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">good_pose</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="s2">&quot;validated&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bad_pose</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="s2">&quot;rejected&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ambigus_core</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">pose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">processed</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">validated</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">rejected</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">bad_core</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">pose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">processed</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">validated</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">rejected</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">good_core</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">pose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">processed</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">validated</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">rejected</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;full data </span><span class="se">\t</span><span class="s2">= </span><span class="si">{0}</span><span class="s2"> poses&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no valid pose </span><span class="se">\t</span><span class="s2">= </span><span class="si">{0}</span><span class="s2"> poses&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">no_pose_core</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;out of cycle </span><span class="se">\t</span><span class="s2">= </span><span class="si">{0}</span><span class="s2"> poses&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_of_cycle_core</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;good data </span><span class="se">\t</span><span class="s2">= </span><span class="si">{0}</span><span class="s2"> poses&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">good_core</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bad data </span><span class="se">\t</span><span class="s2">= </span><span class="si">{0}</span><span class="s2"> poses&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bad_core</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ambigus data </span><span class="se">\t</span><span class="s2">= </span><span class="si">{0}</span><span class="s2"> poses&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ambigus_core</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==========================&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">no_pose_core</span><span class="p">,</span> <span class="n">out_of_cycle_core</span><span class="p">,</span> <span class="n">ambigus_core</span><span class="p">,</span> <span class="n">bad_core</span><span class="p">,</span> <span class="n">good_core</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_pose_proximity"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.check_pose_proximity">[docs]</a><span class="k">def</span> <span class="nf">check_pose_proximity</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function returns None.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="get_good_core"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.get_good_core">[docs]</a><span class="k">def</span> <span class="nf">get_good_core</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">deph_max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha_criterion</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">atomic_cycle</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function analyses the occurencies of data and returns the good_core data.</span>

<span class="sd">    :param data: The data to be analysed.</span>
<span class="sd">    :type data: pandas dataframe</span>
<span class="sd">    :param alpha_criterion: The criterion for alpha.</span>
<span class="sd">    :type alpha_criterion: float</span>
<span class="sd">    :return: The good_core data.</span>
<span class="sd">    :rtype: pandas dataframe&quot;&quot;&quot;</span>
    <span class="p">(</span>
        <span class="n">no_pose_core</span><span class="p">,</span>
        <span class="n">out_of_cycle_core</span><span class="p">,</span>
        <span class="n">ambigus_core</span><span class="p">,</span>
        <span class="n">bad_core</span><span class="p">,</span>
        <span class="n">good_core</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">occurency_analysis</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">alpha_criterion</span><span class="o">=</span><span class="n">alpha_criterion</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ambigus_core</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">deph</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">deph</span> <span class="o">&lt;</span> <span class="n">deph_max</span><span class="p">:</span>
            <span class="n">new_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">good_core</span><span class="p">,</span> <span class="n">ambigus_core</span><span class="p">])</span>
            <span class="n">new_graph</span> <span class="o">=</span> <span class="n">get_graph</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nx</span><span class="o">.</span><span class="n">is_connected</span><span class="p">(</span><span class="n">new_graph</span><span class="p">):</span>
                <span class="n">new_central_mk</span> <span class="o">=</span> <span class="n">get_central_marker</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
                <span class="n">new_cycles</span> <span class="o">=</span> <span class="n">get_cycles</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">new_data</span><span class="p">,</span>
                    <span class="n">graph</span><span class="o">=</span><span class="n">new_graph</span><span class="p">,</span>
                    <span class="n">root</span><span class="o">=</span><span class="n">new_central_mk</span><span class="p">,</span>
                    <span class="n">atomic_cycle</span><span class="o">=</span><span class="n">atomic_cycle</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">atomic_cycle</span><span class="p">:</span>
                    <span class="n">new_data_out</span> <span class="o">=</span> <span class="n">get_occurencies2</span><span class="p">(</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">new_data</span><span class="p">,</span> <span class="n">cycles</span><span class="o">=</span><span class="n">new_cycles</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_data_out</span> <span class="o">=</span> <span class="n">get_occurencies</span><span class="p">(</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">new_data</span><span class="p">,</span> <span class="n">cycles</span><span class="o">=</span><span class="n">new_cycles</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span>
                    <span class="p">)</span>
                <span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">ambigus_core</span><span class="p">,</span> <span class="n">bad_core</span><span class="p">,</span> <span class="n">good_core</span><span class="p">)</span> <span class="o">=</span> <span class="n">occurency_analysis</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">new_data_out</span><span class="p">,</span> <span class="n">alpha_criterion</span><span class="o">=</span><span class="n">alpha_criterion</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ambigus_core</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">good_core</span><span class="p">,</span> <span class="n">ambigus_core</span><span class="p">])</span>
                <span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_data</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="n">deph</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Graph not connected, end recursion here&quot;</span><span class="p">)</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">good_core</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span></div>


<div class="viewcode-block" id="ImageBatch"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.ImageBatch">[docs]</a><span class="k">class</span> <span class="nc">ImageBatch</span><span class="p">(</span><span class="n">pcp</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Container</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">aruco_dict</span><span class="o">=</span><span class="n">aruco</span><span class="o">.</span><span class="n">DICT_6X6_250</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">marker_dimension</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">output_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">camera_matrix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
        <span class="n">distortion_coefficients</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function is used to create an instance of the ArucoTracker class.</span>

<span class="sd">        :param aruco_dict: The dictionary of markers to be used.</span>
<span class="sd">        :type aruco_dict: int</span>
<span class="sd">        :param parameters: The parameters to be used.</span>
<span class="sd">        :type parameters: int</span>
<span class="sd">        :param marker_dimension: The dimension of the markers to be used.</span>
<span class="sd">        :type marker_dimension: int</span>
<span class="sd">        :param output_directory: The directory to output the data to.</span>
<span class="sd">        :type output_directory: str</span>
<span class="sd">        :param camera_matrix: The camera matrix to be used.</span>
<span class="sd">        :type camera_matrix: numpy.ndarray</span>
<span class="sd">        :param distortion_coefficients: The distortion coefficients to be used.</span>
<span class="sd">        :type distortion_coefficients: numpy.ndarray</span>
<span class="sd">        :param data_img: The image data to be used.</span>
<span class="sd">        :type data_img: pandas.DataFrame</span>
<span class="sd">        :param data_detect: The detection data to be used.</span>
<span class="sd">        :type data_detect: pandas.DataFrame</span>
<span class="sd">        :param data_pose: The pose data to be used.</span>
<span class="sd">        :type data_pose: pandas.DataFrame</span>
<span class="sd">        :param directory: The directory to be used.</span>
<span class="sd">        :type directory: str&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aruco_dict</span> <span class="o">=</span> <span class="n">aruco_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marker_dimension</span> <span class="o">=</span> <span class="n">marker_dimension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="n">output_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_matrix</span> <span class="o">=</span> <span class="n">camera_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distortion_coefficients</span> <span class="o">=</span> <span class="n">distortion_coefficients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_img</span> <span class="o">=</span> <span class="n">create_image_dataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span> <span class="o">=</span> <span class="n">create_detect_dataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_pose</span> <span class="o">=</span> <span class="n">create_pose_dataFrame</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;directory&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;directory&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="ImageBatch.run"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.ImageBatch.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function loads a directory of images, detects markers in them, and plots the markers.</span>

<span class="sd">        :param directory: The directory of images to load.</span>
<span class="sd">        :type directory: str</span>
<span class="sd">        :param output_directory: The directory to save outputs to.</span>
<span class="sd">        :type output_directory: str</span>
<span class="sd">        :return: None</span>
<span class="sd">        :rtype: None&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">+</span> <span class="s2">&quot;/_outputs/&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_image_batch</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detect_markers</span><span class="p">(</span><span class="n">plot_markers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enforce</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="ImageBatch.load_image_batch"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.ImageBatch.load_image_batch">[docs]</a>    <span class="k">def</span> <span class="nf">load_image_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function loads image batch from a directory.</span>

<span class="sd">        :param directory: The directory to load the image batch from.</span>
<span class="sd">        :type directory: str</span>
<span class="sd">        :param format: The format of the image batch.</span>
<span class="sd">        :type format: str</span>
<span class="sd">        :param slice: The slice of the image batch.</span>
<span class="sd">        :type slice: int</span>
<span class="sd">        :return: The image batch.</span>
<span class="sd">        :rtype: list&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_img</span> <span class="o">=</span> <span class="n">load_image_batch</span><span class="p">(</span>
            <span class="n">data_img</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_img</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="nb">slice</span><span class="o">=</span><span class="nb">slice</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="ImageBatch.detect_markers"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.ImageBatch.detect_markers">[docs]</a>    <span class="k">def</span> <span class="nf">detect_markers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">plot_markers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">plot_image_type</span><span class="o">=</span><span class="s2">&quot;jpg&quot;</span><span class="p">,</span>
        <span class="n">meta_filename</span><span class="o">=</span><span class="s2">&quot;metadata.h5&quot;</span><span class="p">,</span>
        <span class="n">enforce</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function detects markers in an image and outputs the result.</span>

<span class="sd">        :param parameters: The parameters to use for marker detection.</span>
<span class="sd">        :type parameters: dict</span>
<span class="sd">        :param marker_dimension: The dimension of the markers.</span>
<span class="sd">        :type marker_dimension: int</span>
<span class="sd">        :param aruco_dict: The dictionary of markers to use.</span>
<span class="sd">        :type aruco_dict: dict</span>
<span class="sd">        :param output_directory: The directory to output the results to.</span>
<span class="sd">        :type output_directory: str</span>
<span class="sd">        :param data_img: The image data to use for marker detection.</span>
<span class="sd">        :type data_img: numpy.array</span>
<span class="sd">        :param data_detect: The dataframe to output the results to.</span>
<span class="sd">        :type data_detect: pandas.DataFrame</span>
<span class="sd">        :param plot_markers: Whether to plot the markers.</span>
<span class="sd">        :type plot_markers: bool</span>
<span class="sd">        :param plot_image_type: The type of image to plot.</span>
<span class="sd">        :type plot_image_type: str</span>
<span class="sd">        :return: The dataframe of marker detection results.</span>
<span class="sd">        :rtype: pandas.DataFrame&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">enforce</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span> <span class="o">=</span> <span class="n">detect_markers</span><span class="p">(</span>
                <span class="n">parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span>
                <span class="n">marker_dimension</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">marker_dimension</span><span class="p">,</span>
                <span class="n">aruco_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aruco_dict</span><span class="p">,</span>
                <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="n">data_img</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_img</span><span class="p">,</span>
                <span class="n">data_detect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span><span class="p">,</span>
                <span class="n">plot_markers</span><span class="o">=</span><span class="n">plot_markers</span><span class="p">,</span>
                <span class="n">plot_image_type</span><span class="o">=</span><span class="n">plot_image_type</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">dump_dataframe_HDF</span><span class="p">(</span>
                <span class="n">img_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;detects&quot;</span><span class="p">,</span> <span class="n">dataframe</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">+</span> <span class="n">meta_filename</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span> <span class="o">=</span> <span class="n">cherry_dataframe_HDF</span><span class="p">(</span>
                <span class="n">img_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;detects&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span> <span class="o">=</span> <span class="n">detect_markers</span><span class="p">(</span>
                <span class="n">parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span>
                <span class="n">marker_dimension</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">marker_dimension</span><span class="p">,</span>
                <span class="n">aruco_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aruco_dict</span><span class="p">,</span>
                <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="n">data_img</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_img</span><span class="p">,</span>
                <span class="n">data_detect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span><span class="p">,</span>
                <span class="n">plot_markers</span><span class="o">=</span><span class="n">plot_markers</span><span class="p">,</span>
                <span class="n">plot_image_type</span><span class="o">=</span><span class="n">plot_image_type</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">dump_dataframe_HDF</span><span class="p">(</span>
                <span class="n">img_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;detects&quot;</span><span class="p">,</span> <span class="n">dataframe</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="ImageBatch.estimate_pose"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.ImageBatch.estimate_pose">[docs]</a>    <span class="k">def</span> <span class="nf">estimate_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function checks if there are any makers on the image and, if so, estimates the pose of the camera.</span>

<span class="sd">        :param data_detect: The data from the marker detection.</span>
<span class="sd">        :type data_detect: list</span>
<span class="sd">        :param data_pose: The data from the camera pose estimation.</span>
<span class="sd">        :type data_pose: list</span>
<span class="sd">        :param camera_matrix: The camera matrix.</span>
<span class="sd">        :type camera_matrix: list</span>
<span class="sd">        :param distortion_coefficients: The distortion coefficients.</span>
<span class="sd">        :type distortion_coefficients: list</span>
<span class="sd">        :return: The camera pose estimation.</span>
<span class="sd">        :rtype: list&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Never found makers on image&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_pose</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_pose</span> <span class="o">=</span> <span class="n">estimate_pose</span><span class="p">(</span>
                <span class="n">data_detect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span><span class="p">,</span>
                <span class="n">data_pose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_pose</span><span class="p">,</span>
                <span class="n">camera_matrix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_matrix</span><span class="p">,</span>
                <span class="n">distortion_coefficients</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distortion_coefficients</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="ImageBatch.calculate_inner_angles"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.ImageBatch.calculate_inner_angles">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_inner_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function calculates the inner angles of a data set.</span>

<span class="sd">        :param data: The data set to calculate the inner angles of.</span>
<span class="sd">        :type data: list</span>
<span class="sd">        :return: The inner angles of the data set.</span>
<span class="sd">        :rtype: list&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_angle</span> <span class="o">=</span> <span class="n">calculate_inner_angles</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_angle</span></div>

<div class="viewcode-block" id="ImageBatch.merge_all"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.ImageBatch.merge_all">[docs]</a>    <span class="k">def</span> <span class="nf">merge_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function merges two dataframes together and returns the result.</span>

<span class="sd">        :param data_pose: The first dataframe to merge.</span>
<span class="sd">        :type data_pose: pandas dataframe</span>
<span class="sd">        :param data_detect: The second dataframe to merge.</span>
<span class="sd">        :type data_detect: pandas dataframe</span>
<span class="sd">        :return: The merged dataframe.</span>
<span class="sd">        :rtype: pandas dataframe&quot;&quot;&quot;</span>
        <span class="n">data_temp</span> <span class="o">=</span> <span class="n">merge_dataFrames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_pose</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">merge_dataFrames</span><span class="p">(</span><span class="n">data_temp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_img</span><span class="p">)</span></div>

<div class="viewcode-block" id="ImageBatch.get_graph_data"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.ImageBatch.get_graph_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_graph_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">plot_markers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">criterion</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">deph_max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">alpha_criterion</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
        <span class="n">atomic_cycle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">central_mk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function adds two integers together and returns the result.</span>

<span class="sd">        :param num1: The first integer to add.</span>
<span class="sd">        :type num1: int</span>
<span class="sd">        :param num2: The second integer to add.</span>
<span class="sd">        :type num2: int</span>
<span class="sd">        :return: The sum of num1 and num2.</span>
<span class="sd">        :rtype: int&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_all</span><span class="p">()</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">get_graph</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_graph</span> <span class="o">=</span> <span class="n">graph</span>
        <span class="k">if</span> <span class="n">central_mk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">central_mk</span> <span class="o">=</span> <span class="n">get_central_marker</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">cycles</span> <span class="o">=</span> <span class="n">get_cycles</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">,</span> <span class="n">atomic_cycle</span><span class="o">=</span><span class="n">atomic_cycle</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">central_mk</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">atomic_cycle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_raw</span> <span class="o">=</span> <span class="n">get_occurencies2</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">cycles</span><span class="o">=</span><span class="n">cycles</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_raw</span> <span class="o">=</span> <span class="n">get_occurencies</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">cycles</span><span class="o">=</span><span class="n">cycles</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_graph</span> <span class="o">=</span> <span class="n">get_good_core</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_raw</span><span class="p">,</span>
            <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">,</span>
            <span class="n">deph_max</span><span class="o">=</span><span class="n">deph_max</span><span class="p">,</span>
            <span class="n">alpha_criterion</span><span class="o">=</span><span class="n">alpha_criterion</span><span class="p">,</span>
            <span class="n">atomic_cycle</span><span class="o">=</span><span class="n">atomic_cycle</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">group_calib_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_graph</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">group_calib_detect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_graph</span><span class="o">.</span><span class="n">detects</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">group_calib_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_graph</span><span class="o">.</span><span class="n">poses</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_graph_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_img</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">group_calib_img</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_graph_detect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">group_calib_detect</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_graph_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_pose</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">group_calib_pose</span><span class="p">]</span>
        <span class="n">mks_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">mks_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_graph</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">mks_missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mks_in</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">mks_out</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mks_missing</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;/!</span><span class="se">\\</span><span class="s2"> we lose marker(s) : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mks_missing</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">plot_markers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_xyz</span><span class="p">()</span></div>

<div class="viewcode-block" id="ImageBatch.draw_xyz"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.ImageBatch.draw_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">draw_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_image_type</span><span class="o">=</span><span class="s2">&quot;jpg&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function draws axis markers on an image.</span>

<span class="sd">        :param data: The data to use.</span>
<span class="sd">        :type data: pandas.DataFrame</span>
<span class="sd">        :param path: The path to the output directory.</span>
<span class="sd">        :type path: str</span>
<span class="sd">        :param args: The args to pass to draw_xyz.</span>
<span class="sd">        :type args: tuple</span>
<span class="sd">        :param kwargs: The kwargs to pass to draw_xyz.</span>
<span class="sd">        :type kwargs: dict</span>
<span class="sd">        :return: The path to the output directory.</span>
<span class="sd">        :rtype: str&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_graph</span>
        <span class="n">Np</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Np</span><span class="p">))</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">fname</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">out_fname</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_markers.&quot;</span> <span class="o">+</span> <span class="n">plot_image_type</span>
            <span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;Drawing axis markers on: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="n">imout</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">out_fname</span><span class="p">)</span>
            <span class="n">imout</span> <span class="o">=</span> <span class="n">draw_xyz</span><span class="p">(</span>
                <span class="n">imout</span><span class="p">,</span>
                <span class="n">data</span><span class="o">.</span><span class="n">rvec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                <span class="n">data</span><span class="o">.</span><span class="n">tvec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                <span class="n">camera_matrix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_matrix</span><span class="p">,</span>
                <span class="n">distortion_coefficients</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distortion_coefficients</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="n">checkdir</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">)</span>
            <span class="n">io</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>
                <span class="o">+</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="o">+</span> <span class="s2">&quot;_markers.&quot;</span>
                <span class="o">+</span> <span class="n">plot_image_type</span><span class="p">,</span>
                <span class="n">imout</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="ImageBatch.filter_angles"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.ImageBatch.filter_angles">[docs]</a>    <span class="k">def</span> <span class="nf">filter_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criterion_angular</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function filters the data according to the criterion_angular and returns the locs and the data_detect.</span>

<span class="sd">        :param data: The data to filter.</span>
<span class="sd">        :type data: pandas dataframe</span>
<span class="sd">        :param criterion_angular: The criterion to filter the data.</span>
<span class="sd">        :type criterion_angular: float</span>
<span class="sd">        :return: The locs and the data_detect.</span>
<span class="sd">        :rtype: tuple&quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_angle</span><span class="p">)</span> <span class="o">=</span> <span class="n">filter_angles</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span><span class="p">,</span> <span class="n">criterion_angular</span><span class="o">=</span><span class="n">criterion_angular</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extracted_from_filter_areas</span><span class="p">(</span><span class="n">locs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">criterion_angular</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">locs</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="ImageBatch.filter_areas"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.ImageBatch.filter_areas">[docs]</a>    <span class="k">def</span> <span class="nf">filter_areas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">criterion_area</span><span class="o">=</span><span class="mf">0.65</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function filters the data according to the criterion_area and returns the locs.</span>

<span class="sd">        :param data: The data to be filtered.</span>
<span class="sd">        :type data: pandas dataframe</span>
<span class="sd">        :param criterion_area: The criterion to filter the data.</span>
<span class="sd">        :type criterion_area: float</span>
<span class="sd">        :return: The locs of the filtered data.</span>
<span class="sd">        :rtype: list&quot;&quot;&quot;</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="n">filter_areas</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_graph</span><span class="p">,</span> <span class="n">criterion_area</span><span class="o">=</span><span class="mf">0.65</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">locs</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extracted_from_filter_areas</span><span class="p">(</span><span class="n">locs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_extracted_from_filter_areas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function detects the location of the data and resets the index.</span>

<span class="sd">        :param data_detect: The data to be detected.</span>
<span class="sd">        :type data_detect: data</span>
<span class="sd">        :return: The location of the data and the data itself.</span>
<span class="sd">        :rtype: tuple&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">locs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;detects&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span><span class="p">)</span>

<div class="viewcode-block" id="ImageBatch.draw_markers"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.ImageBatch.draw_markers">[docs]</a>    <span class="k">def</span> <span class="nf">draw_markers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_image_type</span><span class="o">=</span><span class="s2">&quot;jpg&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function draws markers on an image.</span>

<span class="sd">        :param sub_df: The dataframe containing the image data.</span>
<span class="sd">        :type sub_df: pandas dataframe</span>
<span class="sd">        :return: The dataframe with the markers drawn on the image.</span>
<span class="sd">        :rtype: pandas dataframe&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">draw_panda_func</span><span class="p">(</span><span class="n">sub_df</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;This function draws markers on an image.</span>

<span class="sd">            :param ids2D: The ids of the markers.</span>
<span class="sd">            :type ids2D: int</span>
<span class="sd">            :param points2D: The points of the markers.</span>
<span class="sd">            :type points2D: float</span>
<span class="sd">            :param imout: The image to draw on.</span>
<span class="sd">            :type imout: np.array</span>
<span class="sd">            :param rejected: The rejected points.</span>
<span class="sd">            :type rejected: np.array</span>
<span class="sd">            :return: The sub_df.</span>
<span class="sd">            :rtype: pd.DataFrame&quot;&quot;&quot;</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">sub_df</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_img</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_img</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">fname</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">imout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">frame</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">frame</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">imout</span> <span class="o">=</span> <span class="n">frame</span>
            <span class="n">ids2D</span> <span class="o">=</span> <span class="n">sub_df</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="n">points2D</span> <span class="o">=</span> <span class="n">sub_df</span><span class="o">.</span><span class="n">p2d</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">draw_markers</span><span class="p">(</span><span class="n">ids2D</span><span class="p">,</span> <span class="n">points2D</span><span class="p">,</span> <span class="n">imout</span><span class="p">,</span> <span class="n">rejected</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">output_directory</span> <span class="o">=</span> <span class="n">checkdir</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">)</span>
            <span class="n">io</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>
                <span class="o">+</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="o">+</span> <span class="s2">&quot;_markers.&quot;</span>
                <span class="o">+</span> <span class="n">plot_image_type</span><span class="p">,</span>
                <span class="n">imout</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">sub_df</span>

        <span class="n">tqdm</span><span class="o">.</span><span class="n">pandas</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Drawing markers...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_detect</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;images&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">progress_apply</span><span class="p">(</span><span class="n">draw_panda_func</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Drawing markers done&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="ImageBatch.get_central_marker"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.ImageBatch.get_central_marker">[docs]</a>    <span class="k">def</span> <span class="nf">get_central_marker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function gets the central marker from the merged data and returns it.</span>

<span class="sd">        :param self: The object containing the data to be processed.</span>
<span class="sd">        :type self: object</span>
<span class="sd">        :return: The central marker from the merged data.</span>
<span class="sd">        :rtype: object&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">central_mk</span> <span class="o">=</span> <span class="n">get_central_marker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merge_all</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_mk</span></div>

<div class="viewcode-block" id="ImageBatch.get_multigraph"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.ImageBatch.get_multigraph">[docs]</a>    <span class="k">def</span> <span class="nf">get_multigraph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function gets a multigraph from the merged data.</span>

<span class="sd">        :param self: The object containing the merged data.</span>
<span class="sd">        :type self: object</span>
<span class="sd">        :return: The multigraph from the merged data.</span>
<span class="sd">        :rtype: multigraph&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multigraph</span> <span class="o">=</span> <span class="n">get_multigraph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merge_all</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">multigraph</span></div>

<div class="viewcode-block" id="ImageBatch.export_batch"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.ImageBatch.export_batch">[docs]</a>    <span class="k">def</span> <span class="nf">export_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s2">&quot;batch.p&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function is used to add two integers together and return the result.</span>

<span class="sd">        :param num1: The first integer to add.</span>
<span class="sd">        :type num1: int</span>
<span class="sd">        :param num2: The second integer to add.</span>
<span class="sd">        :type num2: int</span>
<span class="sd">        :return: The sum of num1 and num2.</span>
<span class="sd">        :rtype: int&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">inspect</span>

        <span class="k">if</span> <span class="n">spath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span>
        <span class="n">cornerRefinementWinSize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">cornerRefinementWinSize</span>
        <span class="n">cornerRefinementMaxIterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">cornerRefinementMaxIterations</span>
        <span class="n">cornerRefinementMethod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">cornerRefinementMethod</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isroutine</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="n">attributes_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="p">[</span>
            <span class="n">attributes_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">data_batch</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;batch&quot;</span><span class="p">:</span> <span class="n">attributes_dict</span><span class="p">,</span>
            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;cornerRefinementWinSize&quot;</span><span class="p">:</span> <span class="n">cornerRefinementWinSize</span><span class="p">,</span>
                <span class="s2">&quot;cornerRefinementMaxIterations&quot;</span><span class="p">:</span> <span class="n">cornerRefinementMaxIterations</span><span class="p">,</span>
                <span class="s2">&quot;cornerRefinementMethod&quot;</span><span class="p">:</span> <span class="n">cornerRefinementMethod</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data_batch</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">spath</span> <span class="o">+</span> <span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">aruco</span><span class="o">.</span><span class="n">DetectorParameters_create</span><span class="p">()</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">cornerRefinementWinSize</span> <span class="o">=</span> <span class="n">cornerRefinementWinSize</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">cornerRefinementMaxIterations</span> <span class="o">=</span> <span class="n">cornerRefinementMaxIterations</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">cornerRefinementMethod</span> <span class="o">=</span> <span class="n">cornerRefinementMethod</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span></div>

<div class="viewcode-block" id="ImageBatch.load_batch"><a class="viewcode-back" href="../../pycopo.html#pycopo.utils_docstring.ImageBatch.load_batch">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_batch</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lpath</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s2">&quot;batch.p&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function loads a pickled batch file and updates the batch with the given kwargs.</span>

<span class="sd">        :param lpath: The path to the pickled batch file.</span>
<span class="sd">        :type lpath: str</span>
<span class="sd">        :param fname: The name of the pickled batch file.</span>
<span class="sd">        :type fname: str</span>
<span class="sd">        :param kwargs: The keyword arguments to update the batch with.</span>
<span class="sd">        :type kwargs: dict</span>
<span class="sd">        :return: The updated batch.</span>
<span class="sd">        :rtype: Batch&quot;&quot;&quot;</span>
        <span class="n">data_batch</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">lpath</span> <span class="o">+</span> <span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
        <span class="n">data_batch</span><span class="p">[</span><span class="s2">&quot;batch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">data_batch</span><span class="p">[</span><span class="s2">&quot;batch&quot;</span><span class="p">])</span>
        <span class="n">batch</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">data_batch</span><span class="p">[</span><span class="s2">&quot;batch&quot;</span><span class="p">])</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">aruco</span><span class="o">.</span><span class="n">DetectorParameters_create</span><span class="p">()</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">cornerRefinementWinSize</span> <span class="o">=</span> <span class="n">data_batch</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span>
            <span class="s2">&quot;cornerRefinementWinSize&quot;</span>
        <span class="p">]</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">cornerRefinementMaxIterations</span> <span class="o">=</span> <span class="n">data_batch</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span>
            <span class="s2">&quot;cornerRefinementMaxIterations&quot;</span>
        <span class="p">]</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">cornerRefinementMethod</span> <span class="o">=</span> <span class="n">data_batch</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span>
            <span class="s2">&quot;cornerRefinementMethod&quot;</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">batch</span></div></div>
</pre></div>

                </article>
              
              
              
                <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            <div class="bd-footer-content__inner"></div>
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
       Copyright 2023, matis.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://sphinx-doc.org/">Sphinx</a> 5.0.2.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>